#!/usr/bin/perl 

delete @ENV{qw(IFS CDPATH ENV BASH_ENV)};
$ENV{'PATH'}='/bin:/usr/bin:/sbin:/usr/sbin/';

$table = shift @ARGV;
if ($table =~ /^([ &:#-\@\w.]+)$/) {
    $table = $1; #data is now untainted
} else {
    exit(1);
}

$rulefile = shift @ARGV;
if ($rulefile =~ /^([ &:#-\@\w.]+)$/) {
    $rulefile = $1; #data is now untainted
} else {
    exit(1);
}

$postrules = shift @ARGV;
if ($postrules =~ /^([ &:#-\@\w.]+)$/) {
    $postrules = $1; #data is now untainted
} else {
    $postfules = "UNSET";
}

if (!$table || !$rulefile || !($table eq "filter" || $table eq "nat") || $rulefile eq "" || !-f $rulefile) {exit 1;}


if ($postrules ne "UNSET") {
    open (RFH, "$postrules");
    while(<RFH>) {
	chomp;
	my $line = $_;
	$line =~ s/\s+$//g;
	$line =~ s/^\s+//g;
	if ($line ne "") {
	    $postruleshash{"$line"} = 1;
	}
    }
    close(RFH);    
}

open my $fh, '-|' or exec 'iptables-save', ("-t", "$table") or die "iptables-save failed: $!\n";
open(OFH, ">$rulefile.orig") or die "cannot open $rulefile.orig";
$outbuf = "";
while(<$fh>) {
    chomp;
    my $line = $_;
    $line =~ s/\s+$//g;
    $line =~ s/^\s+//g;
    if (!$postruleshash{"$line"}) {
	print OFH "$line\n";
    }
}
close($fh) || die "iptables-save failed\n";
close(OFH);

$rc = $rc>>8;
if ($rc) {
    exit(1);
}

$outbuf = "";
open(FH, "$rulefile.orig");
while(<FH>) {
    chomp;
    my $line = $_;
    $line =~ s/\s+$//g;
    $line =~ s/^\s+//g;
    if ($line eq "COMMIT") {
	# time to load the input rules
	open (RFH, "$rulefile");
	while(<RFH>) {
	    chomp;
	    my $line = $_;
	    $line =~ s/\s+$//g;
	    $line =~ s/^\s+//g;
	    if ($line ne "" && !$rulehash{$line}) {
		$buf .= "$line\n";
		$rulehash{$line} = 1;
	    }
	}
	close(RFH);
	
	# do we have post rules?
	if ($postrules ne "UNSET") {
	    open (RFH, "$postrules");
	    while(<RFH>) {
		chomp;
		my $line = $_;
		$line =~ s/\s+$//g;
		$line =~ s/^\s+//g;
		if ($line ne "" && !$rulehash{$line}) {
		    $buf .= "$line\n";
		    $rulehash{$line} = 1;
		}
	    }
	    close(RFH);
	}
    }
    if ($line ne "" && !$rulehash{$line}) {
	$buf .= "$line\n";
	$rulehash{$line} = 1;
    }

}
close(FH);

open (OFH, ">$rulefile.new");
print OFH "$buf\n";
close(OFH);
if (!-f "$rulefile.new") {
    unlink("$rulefile.orig");
    exit(1);
}


open my $fh, '|-' or exec 'iptables-restore' or die "iptables-restore failed: $!\n";
open(IFH, "$rulefile.new") or die "cannot open $rulefile.new";
while(<IFH>) {
    print $fh "$_";
}
close($fh) || die "iptables-restore failed\n";
close(IFH);

unlink("$rulefile.orig");
unlink("$rulefile.new");
exit($rc);
