#!/usr/bin/perl

delete @ENV{qw(IFS CDPATH ENV BASH_ENV)};
$ENV{'PATH'}='/bin:/usr/bin:/sbin:/usr/sbin/';

$partition = untaint(shift @ARGV);

$LOSETUP=untaint(`which losetup`);
$DD=untaint(`which dd`);
$SFDISK=untaint(`which sfdisk`);
$MV=untaint(`which mv`);
$FILE=untaint(`which file`);

if (!$partition || !-f $partition || !-x $LOSETUP || !-x $DD || !-x $SFDISK) {
    print "USAGE: partition2disk <path/to/disk_partition_file>\n";
    exit(1);
}

chomp($magic=`$FILE $partition`);
if ($magic =~ /boot sector/) {
    exit(0);
}

$size = -s "$partition";
$msize = int(($size / (1024 * 1000)))+ 1;
$bsize = ($size / 512);

$cmd = "$DD if=/dev/zero of=$partition.disk bs=1M count=$msize";
print "$cmd\n";
if (system($cmd)) {do_exit(1);}

open(PFH, "|$SFDISK --force -C999 -uS $partition.disk");
print PFH "63,$bsize,L\n";
print PFH "0,0,0\n";
print PFH "0,0,0\n";
print PFH "0,0,0\n";
close(PFH);

$loopdev = $loopdevp = "";

$attached = 0;
for ($i=0; $i<10 && !$attached; $i++) {
    $loopdev=untaint(`$LOSETUP -f`);
    $rc = system("$LOSETUP $loopdev $partition.disk");
    if ($loopdev ne "" && !$rc) {
	$attached=1;
    }
}
if (!$attached) {
    print STDERR "cannot find free loop device\n";
    do_exit(1);
}


$attached = 0;
for ($i=0; $i<10 && !$attached; $i++) {
    $loopdevp=untaint(`$LOSETUP -f`);
    $rc = system("$LOSETUP -o 32256 $loopdevp $partition.disk");
    if ($loopdevp ne "" && !$rc) {
	$attached=1;
    }
}
if (!$attached) {
    print STDERR "cannot find free loop device\n";
    do_exit(1);
}

$cmd = "$DD if=$partition of=$loopdevp bs=512k";
if (system($cmd)) {do_exit(1);}

$cmd = "$LOSETUP -d $loopdev";
if (system($cmd)) {do_exit(1);}
$loopdev="";

$cmd = "$LOSETUP -d $loopdevp";
if (system($cmd)) {do_exit(1);}
$loopdevp="";

$cmd = "$MV $partition.disk $partition";
if (system($cmd)) {do_exit(1);}

do_exit(0);

sub do_exit() {
    my $ecode = shift;

    if ($loopdev ne "") {
	system("$LOSETUP -d $loopdev");
    }
    if ($loopdevp ne "") {
	system("$LOSETUP -d $loopdevp");
    }
    if ($ecode && -f "$partition.disk") {
	unlink("$partition.disk");
    }
    exit($ecode);
}

sub untaint() {
    $str = shift;
    if ($str =~ /^([ &:#-\@\w.]+)$/) {
	$str = $1; #data is now untainted
    } else {
	$str = "";
    }
    return($str);
}
